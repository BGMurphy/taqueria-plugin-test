var $kQNfl$taquerianodesdk = require("@taqueria/node-sdk");
var $kQNfl$path = require("path");
var $kQNfl$fastglob = require("fast-glob");





const $24b2f47d8f306cb3$var$getContractArtifactFilename = (opts)=>(sourceFile)=>{
        const outFile = (0, $kQNfl$path.basename)(sourceFile, (0, $kQNfl$path.extname)(sourceFile));
        return (0, $kQNfl$path.join)(opts.config.artifactsDir, `${outFile}.tz`);
    };
const $24b2f47d8f306cb3$var$getInputFilename = (opts)=>(sourceFile)=>{
        return (0, $kQNfl$path.join)(opts.config.contractsDir, sourceFile);
    };
const $24b2f47d8f306cb3$var$getCompileCommand = (opts)=>(sourceFile)=>{
        const projectDir = process.env.PROJECT_DIR ?? opts.projectDir;
        if (!projectDir) throw `No project directory provided`;
        const inputFile = $24b2f47d8f306cb3$var$getInputFilename(opts)(sourceFile);
        const baseCommand = `DOCKER_DEFAULT_PLATFORM=linux/amd64 docker run --rm -v \"${projectDir}\":/project -w /project -u $(id -u):$(id -g) ligolang/ligo:next compile contract ${inputFile}`;
        const entryPoint = opts.entrypoint ? `-e ${opts.entrypoint}` : "";
        const syntax = opts["syntax"] ? `-s ${opts["syntax"]} : ""` : "";
        const outFile = `-o ${$24b2f47d8f306cb3$var$getContractArtifactFilename(opts)(sourceFile)}`;
        const cmd = `${baseCommand} ${entryPoint} ${syntax} ${outFile}`;
        return cmd;
    };
const $24b2f47d8f306cb3$var$compileContract = (opts)=>(sourceFile)=>(0, $kQNfl$taquerianodesdk.getArch)().then(()=>$24b2f47d8f306cb3$var$getCompileCommand(opts)(sourceFile)).then((0, $kQNfl$taquerianodesdk.execCmd)).then(({ stderr: stderr  })=>{
            if (stderr.length > 0) (0, $kQNfl$taquerianodesdk.sendErr)(stderr);
            return {
                contract: sourceFile,
                artifact: $24b2f47d8f306cb3$var$getContractArtifactFilename(opts)(sourceFile)
            };
        }).catch((err)=>{
            (0, $kQNfl$taquerianodesdk.sendErr)(" ");
            (0, $kQNfl$taquerianodesdk.sendErr)(err.message.split("\n").slice(1).join("\n"));
            return Promise.resolve({
                contract: sourceFile,
                artifact: "Not compiled"
            });
        });
const $24b2f47d8f306cb3$var$compileAll = (parsedArgs)=>{
    // TODO: Fetch list of files from SDK
    return $kQNfl$fastglob([
        "**/*.ligo",
        "**/*.religo",
        "**/*.mligo",
        "**/*.jsligo"
    ], {
        cwd: parsedArgs.config.contractsDir,
        absolute: false
    }).then((entries)=>entries.map($24b2f47d8f306cb3$var$compileContract(parsedArgs))).then((processes)=>processes.length > 0 ? processes : [
            {
                contract: "None found",
                artifact: "N/A"
            }
        ]).then((promises)=>Promise.all(promises));
};
const $24b2f47d8f306cb3$export$ef7acd7185315e22 = (parsedArgs)=>{
    const p = parsedArgs.sourceFile ? $24b2f47d8f306cb3$var$compileContract(parsedArgs)(parsedArgs.sourceFile).then((result)=>[
            result
        ]) : $24b2f47d8f306cb3$var$compileAll(parsedArgs).then((results)=>{
        if (results.length === 0) (0, $kQNfl$taquerianodesdk.sendErr)("No contracts found to compile.");
        return results;
    });
    return p.then((0, $kQNfl$taquerianodesdk.sendJsonRes)).catch((err)=>(0, $kQNfl$taquerianodesdk.sendAsyncErr)(err, false));
};
var $24b2f47d8f306cb3$export$2e2bcd8739ae039 = $24b2f47d8f306cb3$export$ef7acd7185315e22;


(0, $kQNfl$taquerianodesdk.Plugin).create((i18n)=>({
        schema: "1.0",
        version: "0.1",
        alias: "ligo",
        tasks: [
            (0, $kQNfl$taquerianodesdk.Task).create({
                task: "compile",
                command: "compile [sourceFile]",
                aliases: [
                    "c",
                    "compile-ligo"
                ],
                description: "Compile a smart contract written in a Ligo syntax to Michelson code",
                options: [
                    (0, $kQNfl$taquerianodesdk.Option).create({
                        shortFlag: "e",
                        flag: "entrypoint",
                        description: "The entry point that will be compiled"
                    }),
                    (0, $kQNfl$taquerianodesdk.Option).create({
                        shortFlag: "s",
                        flag: "syntax",
                        description: "The syntax used in the contract"
                    }),
                    (0, $kQNfl$taquerianodesdk.Option).create({
                        shortFlag: "i",
                        flag: "infer",
                        description: "Enable type inference"
                    }), 
                ],
                handler: "proxy",
                encoding: "json"
            }), 
        ],
        checkRuntimeDependencies: ()=>Promise.resolve({
                status: "success",
                report: [
                    {
                        name: "LIGO",
                        path: "ligo",
                        version: ">=0.27.0",
                        kind: "required",
                        met: true
                    }, 
                ]
            }),
        installRunTimeDependencies: ()=>Promise.resolve({
                status: "success",
                output: "LIGO was found in /usr/bin/ligo"
            }),
        proxy: (0, $24b2f47d8f306cb3$export$2e2bcd8739ae039)
    }), process.argv);


//# sourceMappingURL=index.js.map
